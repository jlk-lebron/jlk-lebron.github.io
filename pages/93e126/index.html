<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>项目文档 | 小王的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="logo.png">
    <meta name="description" content="小王的博客">
    
    <link rel="preload" href="/assets/css/0.styles.cc68c345.css" as="style"><link rel="preload" href="/assets/js/app.8d6e8c80.js" as="script"><link rel="preload" href="/assets/js/2.d1a10b95.js" as="script"><link rel="preload" href="/assets/js/63.a381078e.js" as="script"><link rel="prefetch" href="/assets/js/10.078876b2.js"><link rel="prefetch" href="/assets/js/11.0d348b04.js"><link rel="prefetch" href="/assets/js/12.674ecd59.js"><link rel="prefetch" href="/assets/js/13.2cdcfa0f.js"><link rel="prefetch" href="/assets/js/14.7578ba3e.js"><link rel="prefetch" href="/assets/js/15.ed069ce5.js"><link rel="prefetch" href="/assets/js/16.0476bc39.js"><link rel="prefetch" href="/assets/js/17.ffbcbdbd.js"><link rel="prefetch" href="/assets/js/18.564accfd.js"><link rel="prefetch" href="/assets/js/19.0909a6e8.js"><link rel="prefetch" href="/assets/js/20.597bd687.js"><link rel="prefetch" href="/assets/js/21.b7b22c7e.js"><link rel="prefetch" href="/assets/js/22.e3bb53df.js"><link rel="prefetch" href="/assets/js/23.4040088c.js"><link rel="prefetch" href="/assets/js/24.888c00f7.js"><link rel="prefetch" href="/assets/js/25.bae0a4d4.js"><link rel="prefetch" href="/assets/js/26.b4839473.js"><link rel="prefetch" href="/assets/js/27.4c4ac2c9.js"><link rel="prefetch" href="/assets/js/28.6c49ccc3.js"><link rel="prefetch" href="/assets/js/29.51c04b02.js"><link rel="prefetch" href="/assets/js/3.59105492.js"><link rel="prefetch" href="/assets/js/30.61b3e3f7.js"><link rel="prefetch" href="/assets/js/31.e6c5d0ac.js"><link rel="prefetch" href="/assets/js/32.9f59f731.js"><link rel="prefetch" href="/assets/js/33.c57a674a.js"><link rel="prefetch" href="/assets/js/34.7b1d074b.js"><link rel="prefetch" href="/assets/js/35.41092fee.js"><link rel="prefetch" href="/assets/js/36.579a58ab.js"><link rel="prefetch" href="/assets/js/37.bb015b50.js"><link rel="prefetch" href="/assets/js/38.dd4347c1.js"><link rel="prefetch" href="/assets/js/39.682bbcb3.js"><link rel="prefetch" href="/assets/js/4.dcab0898.js"><link rel="prefetch" href="/assets/js/40.07e67951.js"><link rel="prefetch" href="/assets/js/41.653b5e32.js"><link rel="prefetch" href="/assets/js/42.cffbb347.js"><link rel="prefetch" href="/assets/js/43.688a94c9.js"><link rel="prefetch" href="/assets/js/44.42a52d40.js"><link rel="prefetch" href="/assets/js/45.5efaf9e2.js"><link rel="prefetch" href="/assets/js/46.fc11a50f.js"><link rel="prefetch" href="/assets/js/47.c54685cf.js"><link rel="prefetch" href="/assets/js/48.01b4bfa6.js"><link rel="prefetch" href="/assets/js/49.5341fdc9.js"><link rel="prefetch" href="/assets/js/5.9e5cbc4b.js"><link rel="prefetch" href="/assets/js/50.867d8e1a.js"><link rel="prefetch" href="/assets/js/51.7c7c986d.js"><link rel="prefetch" href="/assets/js/52.2e397db2.js"><link rel="prefetch" href="/assets/js/53.5790beaf.js"><link rel="prefetch" href="/assets/js/54.9d4c626a.js"><link rel="prefetch" href="/assets/js/55.19763e86.js"><link rel="prefetch" href="/assets/js/56.dd197ef7.js"><link rel="prefetch" href="/assets/js/57.667b5e2b.js"><link rel="prefetch" href="/assets/js/58.971bd997.js"><link rel="prefetch" href="/assets/js/59.1a5b48bb.js"><link rel="prefetch" href="/assets/js/6.28415204.js"><link rel="prefetch" href="/assets/js/60.e4ee51c1.js"><link rel="prefetch" href="/assets/js/61.c044fdf2.js"><link rel="prefetch" href="/assets/js/62.c6cf56f4.js"><link rel="prefetch" href="/assets/js/64.76f59cd9.js"><link rel="prefetch" href="/assets/js/7.aa2959d8.js"><link rel="prefetch" href="/assets/js/8.55b74a1e.js"><link rel="prefetch" href="/assets/js/9.1809c38a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc68c345.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小王的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/index.html" class="nav-link">首页</a></div><div class="nav-item"><a href="/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><!----> <span class="title" style="display:;">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jlk-lebron/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1849806240878344" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/jlk-lebron/blog-img@main/PicGo/zms.jpg"> <div class="blogger-info"><h3>Lebron Jia</h3> <span>前端小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/docs/index.html" class="nav-link">首页</a></div><div class="nav-item"><a href="/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><!----> <span class="title" style="display:;">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jlk-lebron/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1849806240878344" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5ba336/" class="sidebar-link">初体验</a></li><li><a href="/pages/afcf45/" class="sidebar-link">Vue3通信方式</a></li><li><a href="/pages/aa6377/" class="sidebar-link">Vue常见指令</a></li><li><a href="/pages/34bcc6/" class="sidebar-link">Vue3 组合式API</a></li><li><a href="/pages/4b8ce7/" class="sidebar-link">Pinia</a></li><li><a href="/pages/daca29/" class="sidebar-link">跨域问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Important</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E5%B7%A5%E7%A8%8B%E5%8C%96" title="分类" data-v-06225672>工程化</a></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-07-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">项目文档<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="工程化项目开发文档"><a href="#工程化项目开发文档" class="header-anchor">#</a> 工程化项目开发文档</h1> <h2 id="配置项目"><a href="#配置项目" class="header-anchor">#</a> 配置项目</h2> <h3 id="webpack-prod-js"><a href="#webpack-prod-js" class="header-anchor">#</a> webpack.prod.js</h3> <blockquote><p>在当前项目下创建 <code>config/webpack.prod.js</code></p></blockquote> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> CopyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'copy-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'./js/app.bundle.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">clean</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token comment">// 声明请求app.bundle.js时,请求路径从/开始. 单页面应用时实现二级路由时配置</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'./public/index.html'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 因为favicon并没有在index.js中引入.所以webpack默认不会处理.所以使用插件复制public/favicon.ico到build中.</span>
    <span class="token keyword">new</span> <span class="token class-name">CopyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">patterns</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">'public'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">globOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// htmlplug已经处理过index.html了. copyplug不要再处理index.html,否则无法打包</span>
            <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/index.html'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="webpack-dev-jd"><a href="#webpack-dev-jd" class="header-anchor">#</a> webpack.dev.jd</h3> <blockquote><p>在当前项目下创建 <code>config/webpack.dev.js</code></p></blockquote> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> prod <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.prod'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>prod<span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">directory</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//基于打包后的文件夹作为静态资源服务器的根目录</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token comment">//设置端口号</span>
    <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//自动打开浏览器</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="package-json"><a href="#package-json" class="header-anchor">#</a> package.json</h3> <div class="language-JSON extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack serve --config ./config/webpack.dev.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config ./config/webpack.prod.js&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;copy-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.2.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;css-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.7.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ejs-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;html-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.5.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;style-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.3.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.72.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack-cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.9.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;webpack-dev-server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.9.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;axios&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.27.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moment&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.29.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sme-router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.12.8&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="单页面应用-spa-single-page-application"><a href="#单页面应用-spa-single-page-application" class="header-anchor">#</a> 单页面应用(SPA single page application)</h2> <h3 id="单页面应用介绍"><a href="#单页面应用介绍" class="header-anchor">#</a> 单页面应用介绍</h3> <p>单页面应用（single page application，SPA），就是只有一张Web页面的应用，整个web应用只加载一个HTML 页面并在用户与应用程序交互时动态更新该页面的Web应用程序。</p> <h3 id="单页面应用的优势和缺陷"><a href="#单页面应用的优势和缺陷" class="header-anchor">#</a> 单页面应用的优势和缺陷</h3> <ul><li><p>优点</p> <ol><li>用户体验好. 切换页面不需要再次请求服务器获取页面,页面加载速度更快</li> <li>前后端分离. 前端负责页面动态渲染.后端负责数据响应和数据增删改查(CRUD)</li> <li>减轻服务器压力. 因为只有一个web页面,视图切换时,不会再次向服务器发起请求</li> <li>提高开发效率. 使用一套后端代码.就可以用于web和移动端的多种客户端</li></ol></li> <li><p>缺点</p> <ol><li>不利于SEO. 因为所有的页面都在一个web页面中动态展示,SEO效果不如静态页面</li> <li>第一次加载耗时长.  整个应用的所有页面都写在一个web页面中,包裹js和css都打包成一个文件.第一次加载时就需要更长的时间</li></ol></li></ul> <h3 id="单页面应用原理"><a href="#单页面应用原理" class="header-anchor">#</a> 单页面应用原理</h3> <div class="language- extra-class"><pre><code>在单页 Web 应用程序中，当浏览器向服务器发出第一个请求时，服务器会发回 index.html 文件. 用户需要切换页面时,会改变浏览器地址的路径(但不发送请求). 路径发生变化之后,根据之前配置好的前端路由规则,找到与当前路径匹配的视图,让其视图展示.其他视图隐藏. 展示视图需要渲染的数据,通过ajax获取.然后在前端渲染
</code></pre></div><h3 id="前端路由"><a href="#前端路由" class="header-anchor">#</a> 前端路由</h3> <p>路由: 一套一一对应的规则</p> <p>后端路由: 请求url地址中路径和网络资源的一一对应规则</p> <p>前端路由: 浏览器地址栏的路径和单页面应用中每一个视图的一一对应规则</p> <p>为了实现SPA,我们需要在每一个单页面应用中制定前端路由规则.从而在用户操作时,让正确的视图展示</p> <h3 id="使用sme-router-默认为hash模式"><a href="#使用sme-router-默认为hash模式" class="header-anchor">#</a> 使用sme-router(默认为hash模式)</h3> <ol><li><p>下载</p> <div class="language-Plain extra-class"><pre class="language-plain"><code>npm i sme-router 
</code></pre></div></li> <li><p>在 <code>public/index.html</code>中配置容器元素</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>在 <code>src/index.js</code>中使用 <code>sem-router</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> SMERouter <span class="token keyword">from</span> <span class="token string">'sme-router'</span>
<span class="token comment">// 配置路由内容,挂载在index.html中的那个位置上</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SMERouter</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span> <span class="token comment">// root是index.html中id为root的标签</span>
<span class="token comment">// 访问路径: http://localhost:9000/#/login</span>
router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'登陆页面'</span><span class="token punctuation">)</span> <span class="token comment">// 将render中的字符串,渲染到root中</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 访问路径: http://localhost:9000/#/index</span>
router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'首页'</span><span class="token punctuation">)</span> <span class="token comment">// 将render中的字符串,渲染到root中</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 任何没有配置的路径都会重定向到/login</span>
router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div></li></ol> <h3 id="修改路由为history模式"><a href="#修改路由为history模式" class="header-anchor">#</a> 修改路由为history模式</h3> <ol><li><p>修改 <code>src/index.js</code>中new SMErouter</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 第二个参数为 html5, 则使用history模式</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SMERouter</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">'html5'</span><span class="token punctuation">)</span> 
</code></pre></div></li> <li><p>使用history模式之后,修改的是url中path.开发服务器只配置了 <code>/</code>路由.所以目前访问不到任何内容.需要配置webpack使其生效. 在 <code>webpack.dev.js</code>中修改 <code>devServer</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">directory</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//基于打包后的文件夹作为静态资源服务器的根目录</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token comment">//设置端口号</span>
    <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//自动打开浏览器</span>
    <span class="token literal-property property">historyApiFallback</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//增加此配置项. 当找不到对应路由时，会将其定位到/</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li></ol> <h3 id="使用ejs模板动态渲染页面"><a href="#使用ejs模板动态渲染页面" class="header-anchor">#</a> 使用ejs模板动态渲染页面</h3> <blockquote><p>之前我们使用了sem-router,来实现前端路由. 但是sem-router中不支持响应文件.只支持响应字符串.</p></blockquote> <p>而我们实际开发中,响应的html几乎都要进行动态渲染. 动态渲染就需要使用模板(artTemplate或ejs等).所以我们要使用模板来将html进行动态渲染,得到解析后的字符串,再利用sem-router填充到页面中</p> <ol><li><p>配置 <code>webpack.prod.js</code>,让webpack帮我们解析 <code>ejs</code>模板</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 1.1 下载 ejs-loader </span>
npm i ejs<span class="token operator">-</span>loader 

<span class="token comment">// 1.2 在webpack.prod.js添加loader</span>
<span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.ejs$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'ejs-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">variable</span><span class="token operator">:</span> <span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token comment">// 可以在模板当中使用 data 进行动态渲染. 这个值可以自定义.比如:xxx</span>
          <span class="token comment">// interpolate: '\\{\\{(.+?)\\}\\}', // 表示使用 {{}} 语法. 我们这里不需要</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li> <li><p>在 <code>index.js</code>中引入模板函数.并使用</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 2.1 引入模板</span>
<span class="token keyword">import</span> index <span class="token keyword">from</span> <span class="token string">'./view/index.ejs'</span> <span class="token comment">// index是一个函数,传入数据,返回解析后的字符串</span>
<span class="token keyword">import</span> login <span class="token keyword">from</span> <span class="token string">'./view/login.ejs'</span> <span class="token comment">// login是一个函数,,传入数据,返回解析后的字符串</span>

<span class="token comment">// 2.2 在路由中调用模板函数,响应字符串</span>
router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//调用login时传入数据.相当于给模板中的data赋值</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在 <code>login.ejs</code>中动态插入数据</p> <blockquote><p>webpack中ejs-loader配置变量名是data. 所以模板中用data获取值</p></blockquote> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>登录页面<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">.</span>a<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">.</span>b<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">.</span>c<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
</code></pre></div></li></ol> <h3 id="增加拓展名并添加别名"><a href="#增加拓展名并添加别名" class="header-anchor">#</a> 增加拓展名并添加别名</h3> <ol><li><p>在 <code>webpack.prod.js</code>中配置拓展名</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">//resolve与五大核心概念同级. 之前我们引入模块时.js后缀名可以忽略不写.拓展之后.json和.ejs也可以不写后缀名</span>
<span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">,</span> <span class="token string">'.ejs'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">// 尝试按顺序解析这些后缀名。如果有多个文件有相同的名字，但后缀名不同，webpack 会解析列在数组首位的后缀的文件 并跳过其余的后缀。</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>在 <code>index.js</code>中引入时,可以忽略后缀名</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> index <span class="token keyword">from</span> <span class="token string">'./view/index'</span> 
<span class="token keyword">import</span> login <span class="token keyword">from</span> <span class="token string">'./view/login'</span> 
</code></pre></div></li> <li><p>在 <code>webpack.prod.js</code>中添加别名</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 尝试按顺序解析这些后缀名。如果有多个文件有相同的名字，但后缀名不同，webpack 会解析列在数组首位的后缀的文件 并跳过其余的后缀。</span>
    <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">,</span> <span class="token string">'.ejs'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">v</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/view'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>在 <code>index.js</code>中通过别名引入文件</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> index <span class="token keyword">from</span> <span class="token string">'v/index'</span> <span class="token comment">// index是一个函数,传入数据,返回解析后的字符串</span>
<span class="token keyword">import</span> login <span class="token keyword">from</span> <span class="token string">'v/login'</span> <span class="token comment">// login是一个函数,,传入数据,返回解析后的字符串</span>
</code></pre></div></li></ol> <h3 id="使用后台管理系统模板构建页面"><a href="#使用后台管理系统模板构建页面" class="header-anchor">#</a> 使用后台管理系统模板构建页面</h3> <ol><li><p>将 <code>adminLTE</code>整个目录复制粘贴到 <code>project/public</code>目录下</p></li> <li><p>复制 <code>index.ejs</code>,然后覆盖 <code>src/view/index.ejs</code></p></li> <li><p>在 <code>public/index.html</code>中添加引入js和css的路径. 参考下面的代码</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token comment">// ... 忽略其他</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;stylesheet&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;/adminLTE/css/all.min.css&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;stylesheet&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;/adminLTE/css/adminlte.min.css&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;stylesheet&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;/adminLTE/plugins/toastr/toastr.min.css&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/adminLTE/js/jquery.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/adminLTE/js/bootstrap.bundle.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/adminLTE/js/adminlte.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/adminLTE/plugins/toastr/toastr.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>

</code></pre></div></li> <li><p>访问 <code>http://localhost:9000/index</code>,此时会有错误提示</p> <blockquote><p>webpack为了性能更好,限制一个静态资源文件的大小不能超过250kb</p></blockquote> <p><img src="import/f72937c6-71f1-41d1-acd1-4ae0fe03c652/assets/error.png" alt=""></p></li> <li><p>移除性能提示. 在 <code>webpack.prod.js</code>中进行配置</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// performance和五大核心概念同级 </span>
<span class="token literal-property property">performance</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hints</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 表示关闭性能提示</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li> <li><p>访问 <code>http://localhost:9000/index</code>,展示如下效果</p> <p><img src="import/f72937c6-71f1-41d1-acd1-4ae0fe03c652/assets/index.png" alt=""></p></li></ol> <h3 id="在index-ejs中展示二级路由"><a href="#在index-ejs中展示二级路由" class="header-anchor">#</a> 在index.ejs中展示二级路由</h3> <ol><li><p>在 <code>index.js</code>中修改以及路由 <code>/index</code>,并添加二级路由 <code>/index/adminList</code>和 <code>/index/advList</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span>
    <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">subRoute</span><span class="token operator">:</span> res<span class="token punctuation">.</span><span class="token function">subRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/adminList'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'管理员列表'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/advList'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'广告列表'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在 <code>index.ejs</code>中添加展示二级路由的代码</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;content&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container-fluid&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 这里添加二级路由内容 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">.</span>subRoute<span class="token operator">%</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div></li></ol> <h3 id="点击sidebar切换二级路由"><a href="#点击sidebar切换二级路由" class="header-anchor">#</a> 点击Sidebar切换二级路由</h3> <ol><li><p>在 <code>index.js</code>中将router添加到全局(目的是为了让所有页面都可以直接方法router对象)</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>window<span class="token punctuation">.</span>router <span class="token operator">=</span> router
</code></pre></div></li> <li><p>在 <code>index.ejs</code>中给SideBar中的 <code>管理员列表</code>和 <code>广告列表</code>注册点击事件</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-item menu-open&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>a
        href<span class="token operator">=</span><span class="token string">&quot;javascript:;&quot;</span>
        onclick<span class="token operator">=</span><span class="token string">&quot;router.go('/index/adminList')&quot;</span>
        <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link active&quot;</span><span class="token operator">&gt;</span> 
     	<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-icon fas fa-tachometer-alt&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
	 	<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        	管理员列表
			<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;right fas fa-angle-left&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
	 	<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-item menu-open&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>a
		href<span class="token operator">=</span><span class="token string">&quot;javascript:;&quot;</span>
		onclick<span class="token operator">=</span><span class="token string">&quot;router.go('/index/advList')&quot;</span>
		<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link&quot;</span><span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-icon fas fa-tachometer-alt&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        	广告列表
			<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;right fas fa-angle-left&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>让对应的SideBar高亮</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-item menu-open&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>a
        href<span class="token operator">=</span><span class="token string">&quot;javascript:;&quot;</span>
        onclick<span class="token operator">=</span><span class="token string">&quot;router.go('/index/adminList')&quot;</span>
        <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link &lt;%= data.url=== '/index/adminList' ? 'active': '' %&gt;&quot;</span><span class="token operator">&gt;</span> 
     	<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-icon fas fa-tachometer-alt&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
	 	<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        	管理员列表
			<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;right fas fa-angle-left&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
	 	<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-item menu-open&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>a
		href<span class="token operator">=</span><span class="token string">&quot;javascript:;&quot;</span>
		onclick<span class="token operator">=</span><span class="token string">&quot;router.go('/index/advList')&quot;</span>
		<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link &lt;%= data.url=== '/index/advList' ? 'active': '' %&gt;&quot;</span><span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-icon fas fa-tachometer-alt&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        	广告列表
			<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;right fas fa-angle-left&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
</code></pre></div></li></ol> <h3 id="动态渲染二级路由标题"><a href="#动态渲染二级路由标题" class="header-anchor">#</a> 动态渲染二级路由标题</h3> <p><img src="import/f72937c6-71f1-41d1-acd1-4ae0fe03c652/assets/c_t.png" alt=""></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;content-header&quot;</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container-fluid&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;row mb-2&quot;</span><span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-sm-6&quot;</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>h1 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;m-0&quot;</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/index/adminList'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>管理员列表<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/index/advList'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>广告列表<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>首页<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div><h3 id="定义二级路由adminlist模板"><a href="#定义二级路由adminlist模板" class="header-anchor">#</a> 定义二级路由adminList模板</h3> <ol><li><p>复制 <code>adminList.ejs</code>到 <code>src/view/</code>下面</p></li> <li><p>在 <code>index.js</code>中修改二级路由 <code>/index/adminList/</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/adminList'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">adminList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
   <span class="token comment">// 如果需要注册事件,在render后面进行注册</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'选择器'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> 事件处理函数<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ol> <h2 id="动态渲染管理员列表"><a href="#动态渲染管理员列表" class="header-anchor">#</a> 动态渲染管理员列表</h2> <h3 id="定义服务器代码"><a href="#定义服务器代码" class="header-anchor">#</a> 定义服务器代码</h3> <blockquote><p>参考课上代码</p></blockquote> <h3 id="定义前端代码"><a href="#定义前端代码" class="header-anchor">#</a> 定义前端代码</h3> <ol><li><p>创建axios实例</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/api/axiosInstance.js</span>

<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>封装发送请求获取管理员列表的函数</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/api/reqAdmin.js</span>

<span class="token keyword">import</span> axiosIns <span class="token keyword">from</span> <span class="token string">'./axiosInstance'</span>

<span class="token keyword">function</span> <span class="token function">getAdminList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axiosIns<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5000/findadmins'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> getAdminList <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>在 <code>src/index.js</code>中,找到 <code>/index/adminList</code>路由, 发送请求</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getAdminList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./api/reqAdmin'</span>
router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/adminList'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAdminList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>success
      <span class="token operator">?</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">adminList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'网络错误,请稍后再试'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'网络错误,请稍后再试'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在 <code>webpack.dev.js</code>中配置代理解决跨域问题</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">directory</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">historyApiFallback</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
    <span class="token comment">// 新增proxy</span>
    <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://localhost:5000'</span><span class="token punctuation">,</span> <span class="token comment">//目标服务器</span>
        <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'^/api'</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//将url中/api替换掉</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li> <li><p>修改请求的url地址</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getAdminList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axiosIns<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/findadmins'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>根据数据渲染管理员列表,修改 <code>src/view/adminList.ejs</code>代码</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_id <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>username <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>last_login <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>registe_date <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-danger btn-xs&quot;</span><span class="token operator">&gt;</span>
              删除
         <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-primary btn-xs&quot;</span><span class="token operator">&gt;</span>
              修改密码
         <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>格式化日期时间</p> <ul><li><p>下载格式化日期时间的包  <code>npm i moment</code></p></li> <li><p>封装格式化日期时间函数 <code>src/utils/format.js</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">formatDate</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    item<span class="token punctuation">.</span>last_login <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>last_login<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>registe_date <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>registe_date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>修改 <code>index.js</code>中 <code>/index/adminList</code>路由代码</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> formatDate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils/format'</span>

router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/adminList'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAdminList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>success
      <span class="token operator">?</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">adminList</span><span class="token punctuation">(</span><span class="token function">formatDate</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'网络错误,请稍后再试'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'网络错误,请稍后再试'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ol> <h2 id="完成登录功能"><a href="#完成登录功能" class="header-anchor">#</a> 完成登录功能</h2> <h3 id="后端"><a href="#后端" class="header-anchor">#</a> 后端</h3> <h4 id="jwt-simple"><a href="#jwt-simple" class="header-anchor">#</a> jwt-simple</h4> <p><code>jwt</code>全称:<code>json web token</code>.可以对接口进行安全方面的限制.</p> <p><code>jwt</code>的流程:</p> <div class="language- extra-class"><pre><code>1- 用户输入账号与密码提交表单(前端)

2- 服务端接收到账号与密码对其进行验证.(服务端)

3- 服务端验证成功,会生成token,以响应体或响应头的形式返回给前端..(服务端)

4- 前端接收到token后,对token进行保存.一般存储在localStorage中
</code></pre></div><p>5- 前端再次发送请求时,以请求头(常见:token,authorization)的形式携带token,传递给后台接口.(前端)</p> <p>6- 服务端接收到请求头的token对其进行验证,如果验证token失败(1-token错误 2-token过期)则认为无权限访问该接口(服务端)</p> <p>使用:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jwt-simple'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">KEY</span> <span class="token operator">=</span> <span class="token string">'xxxxx'</span>
<span class="token comment">// 1- 如何生成token</span>
<span class="token comment">// jwt.endcode(荷载的数据，key)</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">userName</span><span class="token operator">:</span> <span class="token string">'zs'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token constant">KEY</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
<span class="token comment">//eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyTmFtZSI6InpoYW5nc2FuIn0.ut9XV4rAGMS6qkg3cnQCKCHLi5sp1rmIUAyvPh27Xck</span>
<span class="token comment">// token由三部分构成：其中都是用到了加密,前二者是base64加密，后者的加密是加密串</span>
<span class="token comment">//      第一部分指的是token相关信息：{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;}</span>
<span class="token comment">//      第二部分指的是荷载信息：{&quot;userName&quot;:&quot;zs&quot;}</span>
<span class="token comment">//      第三部分是加密串。</span>

<span class="token comment">// 2- 如何验证token</span>
jwt<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token constant">KEY</span><span class="token punctuation">)</span> <span class="token comment">// {userName: 'zs'}</span>


</code></pre></div><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 登录路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取用户上传的用户名和密码</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>fields
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 到数据库中查询</span>
    <span class="token keyword">const</span> admin <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">adminLogin</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span> username<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token function">md5</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 生成token</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> tokenManger<span class="token punctuation">.</span><span class="token function">jwtEncode</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>_id<span class="token punctuation">)</span>
    <span class="token comment">// 修改用户的登录时间和token</span>
    <span class="token keyword">await</span> <span class="token function">updateAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>_id<span class="token punctuation">,</span> token<span class="token punctuation">)</span>
      <span class="token comment">// 响应客户端</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> admin <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'网络错误,请稍后再试'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="前端代码"><a href="#前端代码" class="header-anchor">#</a> 前端代码</h3> <ul><li><p><code>/login</code>路由</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// login页面表单校验</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#loginBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> pass <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#pass'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-z]{2,6}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\d{6,8}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发送请求进行登录</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">reqLogin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> user<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> pass <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 存储token</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
          <span class="token comment">// 跳转到首页</span>
        router<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>admin<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'登录失败'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'请按照要求填写表单'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><code>/index</code>路由</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span>
    <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">subRoute</span><span class="token operator">:</span> res<span class="token punctuation">.</span><span class="token function">subRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 将用户信息传递到模板中</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><code>index.ejs</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;user-panel mt-3 pb-3 mb-3 d-flex&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;info&quot;</span><span class="token operator">&gt;</span>
         <span class="token comment">// 动态渲染用户名</span>
         <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;#&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;d-block&quot;</span><span class="token operator">&gt;</span>欢迎您<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div></li></ul> <h2 id="登录权限管理"><a href="#登录权限管理" class="header-anchor">#</a> 登录权限管理</h2> <blockquote><p>只有登录之后,才能访问 首页,广告页和管理员页</p></blockquote> <h3 id="后端代码"><a href="#后端代码" class="header-anchor">#</a> 后端代码</h3> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/verifyToken'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从请求头中获取客户端上传的token</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'authorization'</span><span class="token punctuation">)</span>
  <span class="token comment">// 从数据库中根据token查找用户信息</span>
  <span class="token keyword">const</span> admin <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 如果有用户信息,则解码token</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> tokenManger<span class="token punctuation">.</span><span class="token function">jwtDecode</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
    <span class="token comment">// 判断token是否超出有效期(当前时间戳比token存储的时间戳小则有效)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> result<span class="token punctuation">.</span>expires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// token有效</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// token无效</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录失效,请重新登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token comment">// 如果没有指定用户信息,说明没有登录或已经退出了</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录失效,请重新登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="前端代码-2"><a href="#前端代码-2" class="header-anchor">#</a> 前端代码</h3> <p>每次访问首页,广告页,管理员页都要先验证token是否有效. 以 <code>/index</code>路由为例</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 发请求验证token</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// token无效则提示用户</span>
    toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'登录失效请重新登录'</span><span class="token punctuation">)</span>
      <span class="token comment">// 重定向到登录页面</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token comment">//阻止后续代码执行</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span>
    <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">subRoute</span><span class="token operator">:</span> res<span class="token punctuation">.</span><span class="token function">subRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="退出登录"><a href="#退出登录" class="header-anchor">#</a> 退出登录</h2> <h3 id="后端代码-2"><a href="#后端代码-2" class="header-anchor">#</a> 后端代码</h3> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">logoutAdmin</span><span class="token punctuation">(</span><span class="token parameter">_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> adminModel<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">$set</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>fields
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">logoutAdmin</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'退出成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'退出失败'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="前端代码-3"><a href="#前端代码-3" class="header-anchor">#</a> 前端代码</h3> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'登录失效请重新登录'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span>
    <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token literal-property property">subRoute</span><span class="token operator">:</span> res<span class="token punctuation">.</span><span class="token function">subRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
 <span class="token comment">// 新增代码: </span>
 <span class="token comment">// 给退出登录按钮注册点击事件</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#logoutBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给服务器发送请求,删除数据库中存储的token</span>
    <span class="token keyword">await</span> <span class="token function">reqLogout</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>_id<span class="token punctuation">)</span>
    <span class="token comment">// 删除本地缓存中的token</span>
    localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    toastr<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'已退出登录'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="广告页增删改查"><a href="#广告页增删改查" class="header-anchor">#</a> 广告页增删改查</h2> <h3 id="添加广告"><a href="#添加广告" class="header-anchor">#</a> 添加广告</h3> <h4 id="后端代码-3"><a href="#后端代码-3" class="header-anchor">#</a> 后端代码</h4> <ul><li><p>修改 <code>server.js</code> 中formidableMiddleware中间件</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>npm i express<span class="token operator">-</span>formidable
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">formidableMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">uploadDir</span><span class="token operator">:</span> <span class="token string">'./public/uploadDir'</span><span class="token punctuation">,</span> <span class="token comment">//上传的图片存储位置</span>
      <span class="token literal-property property">keepExtensions</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 保留上传图片的后缀名</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token punctuation">)</span>
</code></pre></div></li> <li><p>广告操作之前要先验证token</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleWare</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 验证token</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'authorization'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> admin <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> tokenManger<span class="token punctuation">.</span><span class="token function">jwtDecode</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> result<span class="token punctuation">.</span>expires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果token验证通过,则继续往下执行.否则直接响应</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'token失效请重新登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'token失效请重新登录'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>配置添加广告的路由</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/addAdv'</span><span class="token punctuation">,</span>middleWare<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> req<span class="token punctuation">.</span>fields <span class="token comment">// 获取除文件外的其他字段</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> req<span class="token punctuation">.</span>files <span class="token comment">// 获取文件</span>
  <span class="token comment">// 解构文件和文件外字段信息</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> advTitle<span class="token punctuation">,</span> advCategory<span class="token punctuation">,</span> advLink <span class="token punctuation">}</span> <span class="token operator">=</span> fields 
  <span class="token keyword">const</span> <span class="token punctuation">{</span> file <span class="token punctuation">}</span> <span class="token operator">=</span> files
  <span class="token comment">// 拼接客户端访问图片地址</span>
  <span class="token keyword">const</span> advAvatar <span class="token operator">=</span>
    <span class="token string">'http://localhost:5000/uploadDir/'</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 存储到数据库中</span>
    <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      advTitle<span class="token punctuation">,</span>
      advAvatar<span class="token punctuation">,</span>
      advCategory<span class="token punctuation">,</span>
      advLink<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'广告图片添加成功'</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'广告图片添加失败'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="前端代码-4"><a href="#前端代码-4" class="header-anchor">#</a> 前端代码</h4> <ul><li><p>定义发送请求添加广告的函数</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addAdv</span><span class="token punctuation">(</span><span class="token parameter">formdata</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// formdata就是要传递的数据</span>
  <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/addAdv'</span><span class="token punctuation">,</span> formdata<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 因为要使用formdata,所以请求头必须手动设置</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'multipart/form-data'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>修改 <code>/index/advList</code>路由</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/advList'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">advList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//给保存按钮绑定点击事件</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#addAdvBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建formdata对象</span>
    <span class="token keyword">const</span> formdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token comment">// 发送请求</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addAdv</span><span class="token punctuation">(</span>formdata<span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>success <span class="token operator">?</span> toastr<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">:</span> toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
      <span class="token comment">// 重新渲染</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">advList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h4 id="预览图片"><a href="#预览图片" class="header-anchor">#</a> 预览图片</h4> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm input[type=file]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> preImg <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#showImg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 1- 生成FileReader实例</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2- 生成图片base64数据 如果不选择图片,则无法解析.会报错.所以用try包起来</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment">// 3- 通过load事件得到结果</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        preImg<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span>
        preImg<span class="token punctuation">.</span>src <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果不选择图片则隐藏预览</span>
      preImg<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="动态展示广告列表"><a href="#动态展示广告列表" class="header-anchor">#</a> 动态展示广告列表</h3> <h4 id="后端代码-4"><a href="#后端代码-4" class="header-anchor">#</a> 后端代码</h4> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getAdvs'</span><span class="token punctuation">,</span> middleWare<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'广告图片查找失败,请稍后在试'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="前端代码-5"><a href="#前端代码-5" class="header-anchor">#</a> 前端代码</h4> <ul><li><p>修改 <code>/index/advList</code>路由</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/index/advList'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span> 忽略

   <span class="token comment">// 新增获取广告数据的方法</span>
  result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAdvs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将数据传递给advList模板</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">advList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#addAdvBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>忽略
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>修改 <code>advList.ejs</code></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>tbody<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>tr<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_id <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>advTitle <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>

              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>img width<span class="token operator">=</span><span class="token string">&quot;60&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;&lt;%= data[i].advAvatar %&gt;&quot;</span> alt<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>advCategory <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;&lt;%= data[i].advLink %&gt;&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>advLink <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>advInsertDate <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>advMotifyDate <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-danger btn-xs&quot;</span><span class="token operator">&gt;</span>删除<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-primary btn-xs&quot;</span><span class="token operator">&gt;</span>修改<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">&gt;</span>
</code></pre></div></li></ul> <h3 id="删除广告"><a href="#删除广告" class="header-anchor">#</a> 删除广告</h3> <h4 id="后端代码-5"><a href="#后端代码-5" class="header-anchor">#</a> 后端代码</h4> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/deleteAdv'</span><span class="token punctuation">,</span> middleWare<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取id</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>fields
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据id找到指定数据</span>
    <span class="token keyword">const</span> adv <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 拼接字符串,为了删除图片文件</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> adv<span class="token punctuation">.</span>advAvatar<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5000/uploadDir/'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    path <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../public/uploadDir'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
     <span class="token comment">// 删除数据</span>
    <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 删除图片</span>
    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
      <span class="token comment">// 获取最新数据</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'广告删除成功'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'广告删除失败,请稍后在试'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="前端代码-6"><a href="#前端代码-6" class="header-anchor">#</a> 前端代码</h4> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#advListWrap button.btn-danger'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取要删除的数据的id</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>id
    <span class="token comment">// 发送请求删除数据</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">deleteAdv</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token comment">// 提示用户</span>
    result<span class="token punctuation">.</span>success <span class="token operator">?</span> toastr<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">:</span> toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
    <span class="token comment">// 重新渲染</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">advList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="注意"><a href="#注意" class="header-anchor">#</a> 注意:</h3> <h4 id="bug"><a href="#bug" class="header-anchor">#</a> bug:</h4> <p>原因: 增删改之后,重新渲染了advList. 重新生成了dom. 所以之前注册的事件,都失效了.</p> <p>解决: 利用事件委托,委托给advList的某个父元素</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#index-content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>
    <span class="token string">'click'</span><span class="token punctuation">,</span>
    <span class="token string">'#advListWrap button.btn-danger'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>id
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">deleteAdv</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      result<span class="token punctuation">.</span>success <span class="token operator">?</span> toastr<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">:</span> toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">advList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
</code></pre></div><h3 id="修改广告"><a href="#修改广告" class="header-anchor">#</a> 修改广告</h3> <h4 id="后端代码-6"><a href="#后端代码-6" class="header-anchor">#</a> 后端代码</h4> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/updateAdv'</span><span class="token punctuation">,</span> middleWare<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取用户上传的新数据</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> advTitle<span class="token punctuation">,</span> advCategory<span class="token punctuation">,</span> advLink<span class="token punctuation">,</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>fields
  <span class="token keyword">const</span> <span class="token punctuation">{</span> file <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>files
 <span class="token comment">// 判断是否上传新的图片了.file.size有值说明有新图片</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拼接新图片的访问地址</span>
    <span class="token keyword">const</span> advAvatar <span class="token operator">=</span>
      <span class="token string">'http://localhost:5000/uploadDir/'</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除之前的照片</span>
      <span class="token comment">// 获取要修改的这条数据,为了拿到之前的图片的访问地址</span>
      <span class="token keyword">const</span> adv <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 获取之前图片的文件名</span>
      <span class="token keyword">const</span> filename <span class="token operator">=</span> adv<span class="token punctuation">.</span>advAvatar<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        <span class="token string">'http://localhost:5000/uploadDir/'</span><span class="token punctuation">,</span>
        <span class="token string">''</span>
      <span class="token punctuation">)</span>
      <span class="token comment">// 先更新数据</span>
      <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">_id</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">$set</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            advTitle<span class="token punctuation">,</span>
            advCategory<span class="token punctuation">,</span>
            advLink<span class="token punctuation">,</span>
            advAvatar<span class="token punctuation">,</span>
            <span class="token literal-property property">advMotifyDate</span><span class="token operator">:</span> <span class="token function">moment</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
	<span class="token comment">// 拼接即将被删除的文件的绝对路径</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../public/uploadDir'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
      <span class="token comment">// 删除图片</span>
      fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
	<span class="token comment">// 查找最新的数据,响应</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> result<span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'修改成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'修改失败,请稍后再试'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明这次修改没有新图片</span>
    
    <span class="token comment">// 删除错误存储的无后缀名文件</span>
    <span class="token comment">// 拼接错误文件路径</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
      __dirname<span class="token punctuation">,</span>
      <span class="token string">'../public/uploadDir'</span><span class="token punctuation">,</span>
      file<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 删除错误文件</span>
    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment">// 修改数据</span>
      <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">_id</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">$set</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            advTitle<span class="token punctuation">,</span>
            advCategory<span class="token punctuation">,</span>
            advLink<span class="token punctuation">,</span>
            <span class="token literal-property property">advMotifyDate</span><span class="token operator">:</span> <span class="token function">moment</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
      <span class="token comment">// 查找最新数据响应给浏览器</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> advModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> result<span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'修改成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'修改失败,请稍后再试'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="前端代码-7"><a href="#前端代码-7" class="header-anchor">#</a> 前端代码</h4> <ul><li><p>点击添加广告按钮,修改模态框标题,清空表单</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#index-content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'#addBtn'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.modal .modal-title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'添加广告'</span><span class="token punctuation">)</span> <span class="token comment">// 修改模态框标题</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//清空表单</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#showImg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token comment">//隐藏预览</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>给修改按钮注册事件</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#index-content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'.updateAdvBtn'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>id
    <span class="token comment">// 将id存储到localStorage中,为后面功能做准备</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span> 

    <span class="token comment">// 获取当前要修改的数据, 填充到表单中</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAdvOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.modal .modal-title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'修改广告'</span><span class="token punctuation">)</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm input[name=&quot;advTitle&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>advTitle<span class="token punctuation">)</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm input[name=&quot;advCategory&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>advCategory<span class="token punctuation">)</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm input[name=&quot;advLink&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>advLink<span class="token punctuation">)</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#showImg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>advAvatar
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#showImg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#addAdvBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'修改'</span><span class="token punctuation">)</span> <span class="token comment">//修改模态框保存按钮文本</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>修改 <code>保存/修改</code>按钮的事件处理函数</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#index-content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'#addAdvBtn'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建formdata</span>
    <span class="token keyword">const</span> formdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#uploadAdvForm'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 如果是是保存按钮,则添加广告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#addAdvBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'保存'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addAdv</span><span class="token punctuation">(</span>formdata<span class="token punctuation">)</span>
        <span class="token comment">// 如果是修改按钮,则修改广告</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#addAdvBtn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'修改'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// form表单中没有id,所以额外添加id字段到formdata中</span>
      formdata<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">updateAdv</span><span class="token punctuation">(</span>formdata<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    result<span class="token punctuation">.</span>success <span class="token operator">?</span> toastr<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">:</span> toastr<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">advList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/c190e1/"><div>
            函数进阶
            <!----></div></a> <span class="date">08-19</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/91cc90/"><div>
            react-router-dom
            <!----></div></a> <span class="date">08-19</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/9705e8/"><div>
            create-react-app
            <!----></div></a> <span class="date">08-19</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:16631085276@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/jlk-lebron" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Lebron Jia  | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8d6e8c80.js" defer></script><script src="/assets/js/2.d1a10b95.js" defer></script><script src="/assets/js/63.a381078e.js" defer></script>
  </body>
</html>
